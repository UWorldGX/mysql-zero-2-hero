# 14 MySQL数据类型+

*****

## 14.1 MySQL数据类型再梳理

<img src="https://i.imgtg.com/2023/07/05/OxAofr.png" alt="OxAofr.png" border="0">

* 常见数据类型的属性如下:

| 属性 | 作用 |
| --- | --- |
| `NULL/NOT NULL` | 字段是否包含`NULL` |
| `DEFAULT` | 默认值 |
| `PRIMARY KEY` | 主键 |
| `AUTO_INCREMENT` | 自动递增，适用于整数类型 |
| `UNSIGNED` | 无符号 |
| `CHARACTER SET name` | 指定的字符集 |

> 关于`CHARACTER SET name`
> * 创建数据库时可以指定字符集。
> * 创建表时候可以指定表的字符集。
> * 创建表时候，单独一个字段也可以指定它的字符集。
> * 若未指定字符集，则按照字段 -> 表 -> 数据库 -> my.ini中的默认字符集进行上溯，就近取值。

## 14.2 整数类型

### 14.2.1 介绍

| 类型名 | 字节数 | 最大值 |
| --- | --- | --- |
| `TINYINT` | 1 | ±128, 255 |
| `SMALLINT` | 2 | ±32767， 65535 |
| `MEDIUMINT` | 3 | ±8388607，16777215 |
| `INT` | 4 | ±2147483647，4294967295 |
| `BIGINT` | 8 | |

> MySQL 5.7中，对表进行DESC时，整数类型字段的类型名后会加括号，括号内指明这个类型显示数据最大的宽度，即默认的宽度(M)。注意*正负号也算宽度的一部分*。
> 注意`BIGINT`类型无符号。

### 14.2.2 可选属性

整数类型的可选属性如下:

* `M`:表示显示宽度，取值范围为(0, 255)。该项功能需要配合`ZEROFILL`使用。当某条记录的该字段的值小于这个宽度时，不足部分会被0填充。
    * 但如果插入数据的位数高于这个值，**并不会导致插入失败或者数据被截断**。故在MySQL 8.0.17开始，不推荐使用这个属性。
    * 可以这样指定整数类型字段的显示宽度:
    ```sql
    CREATE TABLE table_1
    (
        x INT(5) ZEROFILL
    );
    ```

* `UNSIGNED`:指明无符号。

* `ZEROFILL`:不足`M`位数的部分用0填充。必须与`M()`和`UNSIGNED`配合使用才有效果。若整数超过`M`则数据照样存储，且无需再用0填充。
    * 使用`ZEROFILL`时，会自动加上`UNSIGNED`。

## 14.3 浮点类型

共包含`FLOAT/DOUBLE/REAL`三种。

* 其中，若设置过SQL模式中的`REAL_AS_DOUBLE`，则REAL默认就是DOUBLE。

```sql
SET sql_mode = REAL_AS_FLOAT； -- 可以这样改成REAL与FLOAT等价
```

> 注意两种浮点类型的无符号范围只相当于*有符号部分的正数部分*。原因在于，MySQL中浮点类型值的存储由`符号(S)`，`尾数(M)`与`阶码(E)`组成。即**无论如何都会储存符号部分**。
> 因此浮点类型**不必指定`UNSIGNED`**。

### 14.3.1 数据精度说明

* MySQL允许使用非标准语法:`FLOAT/DOUBLE(m, d)`，m是精度（整数位+小数位），d是标度（小数位）。涉及到数据库迁移时不要这么写。
* 若不指定精度和标度，`FLOAT/DOUBLE`将按实际精度（由计算机决定）显示。
* `UNSIGNED`不会改变精度和标度。

* 不论是否显式设置了精度，处理方案如下：
    * 若整数部分溢出，MySQL将报错；
    * 若小数部分溢出，则如下处理:
        * 四舍五入后整数部分未溢出，则仅警告并成功插入、按照四舍五入截断小数部分；
        * 四舍五入后整数部分溢出，报错。

* 在MySQL 8.0.17开始，不推荐使用精度和标度。

### 14.3.2 精度误差说明

* 如同其他语言，MySQL中的浮点类型存在误差。且FLOAT > DOUBLE。避免直接比较两个浮点类型的值。

## 14.4 定点类型

即`DECIMAL`（也叫`DEC/NUMERIC`）类型。MySQL使用`DECIMAL(m, d)`定义它。m、d的含义同上。

* DECIMAL的最大存储空间与`DOUBLE`一样，但是实际存储空间为`m+2`个字节。在一些精度要求不高的情况下，DOUBLE的取值范围更大。
* 定点数在内部以字符串形式存储，保证了精确性。
* 默认的DECIMAL为`DECIMAL(10,0)`。数据精度溢出时则视情况进行四舍五入截断/报错，处理逻辑同上。

## 14.5 位类型

即`BIT`类型，可以存储二进制数，与其他类型类似，定义为`BIT(M)`，M为二进制的位数，默认为1，最大为64。占用的空间约为`(M + 7) / 8`个字节。

## 14.6 日期和时间类型

### 14.6.1 概述

* `YEAR`表示年，占单个字节；
* `DATE`表示年月日，占3个字节；
* `TIME`表示时分秒，占3个字节；
* `DATETIME`表示年月日时分秒，占8个字节；
* `TIMESTAMP`表示带时区的年月日时分秒，占4个字节(最大值为2038年)；

> 注意`TIME`还具有表示时间间隔的功能，因此范围是±839小时而非±24小时。

### 14.6.2 YEAR类型

* 占1个字节，曾可用4位或2位字符串表示，在MySQL 5.5.27以后已经**不推荐使用两位字符串格式存储**，在MySQL 8.0.17以后则不推荐指定YEAR类型的宽度。

* 添加数据时，字符串或整数类型的年份均可。

> 用2位字符串表示`YEAR`，最小值为00，最大值为99.
> * 01~69对应2001~2069；
> * 70~99对应1970~1999；
> * 整数类型的00或0对应0000；
> * 字符类型的'0'对应2000.

### 14.6.3 DATE类型

* 格式为`YYYY-MM-DD`，插入该种类型数据时，需要满足一定的格式条件。'YYYY-MM-DD'或者'YYYYMMDD'均可。
* 使用`CURRENT_DATE()/NOW()`函数，会插入当前日期。

### 14.6.4 TIME类型

* 使用`HH-MM-SS`格式。
* 插入数据时，也可使用不同的格式:
    * 使用带冒号的字符串，如`D HH:MM:SS`，`HH:MM`，`D HH`，`SS`；其中D表示0~34以内的天数，D在实际存储时会乘上24并追加到HH上。
    * 也可以使用不带冒号的字符串，如`HHMMSS`。

### 14.6.5 DATETIME类型

* 标准格式为`YYYY-MM-DD HH:MM:SS`。推荐使用这种字符串插入数据。也可以用无分隔符和冒号的形式。
* 在日期时间类型中占用最多的8个字节。
* 可通过`CURRENT_TIMESTAMP()/NOW()/SYSDATE()`插入当前时间日期。

### 14.6.6 TIMESTAMP类型

* 占用4个字节，存储范围远小于DATETIME.超出存储范围的数据插入将抛出异常。
* 使用时需要根据当前时间所在的时区将时间转换为UTC，这个UTC在不同时区查询时会根据时区转换为不同的时间。
* 插入格式同`DATETIME`。

> 修改时区的命令:
> ```sql
> SET time_zone = '+9.00';
> ```

* 实际开发中用的最多的是`DATETIME`类型。只有存储商品发布时间、注册时间等需要经常计算的场景时使用`TIMESTAMP`。

## 14.7 文本字符串类型

### 14.7.1 总览

| 类型 | 占用字节 | M/L范围 |
| --- | --- | --- |
| `CHAR(M)` | M | 0~255 | 
| `VARCHAR(M)` | M + 1 | 0~65535 |
| `TINYTEXT` | L + 2 | 0~255 |
| `TEXT` | L + 2 | 0~65535 |
| `MEDIUMTEXT` | L + 3 | 0~16777215 |
| `LONGTEXT` | L + 4 | 0~? |
| `ENUM` | 1或2 | 0~65535 |
| `SET` | 1,2,3,4,8 | 0~64 |

### 14.7.2 CHAR与VARCHAR

* `CHAR(M)`为固定长度字符串，M既是最大长度，又可指明占用空间。默认为1。若存储的字符串长度小于M，则字符串右侧以空格补齐。实际检索时，这字符串尾部的空格会被去除。

* `VARCHAR(M)`必须指明宽度，否则报错。在MySQL 5.0以后，M指的**仅仅是总共能存储的字符数**。
    * 检索数据时也会保留字符串尾的空格。
    * VARCHAR存在最大字节长度65535，实际能存储的字符数要依据字符集不同进行衰减。例如utf8mb3字符集各字符占3个字节，此时VARCHAR的存储上限为21844个字符。

* 总的来说，`CHAR`适用于存储长度不大或需要很高读写速度的字符串。其他情况用`VARCHAR`。根据`InnoDB`引擎的存储逻辑，内部的行存储格式并没有区分固定长度和可变长度，而且**主要影响性能的因素是数据行使用的存储总量**，由于`CHAR`占用空间较大，因此建议使用`VARCHAR`。

### 14.7.3 TEXT类型

* 用于保存文本类型的字符串。向`TEXT`类型读写数据时，系统会自动按照实际长度存储，不进行字符串尾增删空格的操作，不需要预先指定长度。每种`TEXT`类型的存储长度与占用字节都不同。
* 由于`TEXT`长度可变，MySQL**不允许使用`TEXT`字段作为主键**。

* `TEXT`适合存储长度较大的字符串，搜索速度不如`VARCHAR`快，**不具备默认值**，而且与`BLOB`类型一样，删除以后容易流下“空洞”使得文件碎片较多，因此频繁使用的表不建议使用`TEXT`类型，最好另外建立一张表。

### 14.7.4 ENUM类型

* 取值范围需要在定义字段时进行指定。ENUM类型只允许从它的成员中选取其中一个作为字段的值，不能一次选取多个值。占用的空间也根据指定的成员个数确定。

* 该类型忽略大小写。如同其他语言，枚举中的每个元素从左到右可分别对应整数1、2、3...

```sql
CREATE TABLE test_num
(
    seasons ENUM('spring','summer','fall','winter')
);
```

### 14.7.5 SET类型

* 表示一个字符串对象，可以包含0~64个成员。设置字段的值时可以取取值范围内的0~64个值。
* SET所占用的字节数根据包含的成员个数确定。一般来说，SET占用`2 ^ (L / 8)`个字节（向下取整）。
* SET类型成员具有唯一性，若定义时包含了重复的成员、插入了重复的成员时会自动进行去重。

## 14.8 二进制字符串类型

主要包括`BINARY`、`VARBINARY`、`BLOB`等类型，可存储图片、视频等二进制文件。

### 14.8.1 BINARY和VARBINARY

* 如同`CHAR(M)`与`VARCHAR(M)`之间的关系，`BINARY(M)`固定存储M长度的二进制数，占M个字节，不指定M则M固定为1，不足的部分用'\0'填充。
* `VARBINARY(M)`为可变长度的二进制字符串，总字节数不能超过行字节数上限65535，除了存储数据外还需要1或2个字节来储存长度。如同`VARCHAR(M)`，`VARBINARY(M)`必须指明长度。

### 14.8.2 BLOB

* `BLOB`是一个二进制大对象，可容纳可变容量的数据。

* 在实际工作中，往往不会直接用`BLOB`存储大对象数据，通常会将图片、音视频储存到*服务器的磁盘上*，在MySQL中只存储访问路径。

* 如上文所述，`BLOB`和`TEXT`类型删除以后容易流下“空洞”使得文件碎片较多，建议定期使用`OPTIMIZE TABLE`对数据库进行碎片整理。
* 若对大文本数据进行模糊查询，MySQL提供了*前缀索引*。但是仍然要**避免直接查询大型的`TEXT`或`BLOB`值**，否则会造成毫无意义地在网络上传输大量的数据。
* 频繁使用的表不建议使用`TEXT/BLOB`类型，最好将这种数据列分离到单独的一张表中。

## 14.9 JSON类型

* JSON可将JavaScript中的一组数据转化为字符串进行网络传输，并可转化为其他语言中的实体对象。
* MySQL 5.7即支持JSON, 8.0中提供了可进行自动验证的JSON文档和优化的存储结构，存储JSON类型数据更加方便与高效。

* 可通过如下方式访问JSON内存储的对象:

```sql
SELECT js -> '$.name' AS `name`, js -> '$.address' AS `address`
FROM table1;
```

> 此外，MySQL还支持空间类型(与OpenGIS对接)。

## 14.10 选取原则

* 任何字段如果是非负数，必须显式指明为`UNSIGNED`。
* 小数类型都应该使用`DECIMAL`。禁止使用`FLOAT`和`DOUBLE`。若数据超出了`DECIMAL`能存储的范围，则应该把整数、小数部分分开存储。
* 如果存储的字符串长度几乎相等，使用定长的`CHAR`字符串。
* `VARCHAR`是可变长字符串，不预先分配存储空间。长度不得超过5000.如果长度大于此值，则应该使用`TEXT`类型独立出一张表，用主键相对应。