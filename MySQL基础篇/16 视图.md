# 16 视图

*****

## 16.1 常见的数据库对象

| 对象 | 描述 |
| --- | --- |
| 表 | 存储数据的逻辑单元，以行（记录）和列（字段）的形式存储数据 |
| 数据字典 | 即系统表，存储数据库相关信息的表，由数据库系统维护，通常不应该被修改 |
| 约束 | 执行数据校验，保证数据完整性的规则 |
| 视图 | 一个或多个表的数据的逻辑显示，并不存储数据 |
| 索引 | 用于提高查询性能 |
| 存储过程 | 用于完成一次的业务处理，没有返回值，但可以通过传出参数将多个值传给调用环境 |
| 存储过程 | 用于完成一次特定的计算，具有一个返回值 |
| 触发器 | 当数据库发生特定事件后被触发，完成相应的处理 |

## 16.2 视图概述

* 视图是一种**虚拟表**，本身不存储数据，占用很少的内存空间，适用于大型项目。
* 视图必须**建立在已有表的基础上**, 已有的表称为基表。

* 向视图提供数据的是SELECT子句，可将其视为固定化的查询语句（查询中字段的别名将作为视图中列的名称）。
    * SELECT子句允许任何格式，允许多表查询，原本基表中不存在的字段也可以作为视图的基字段，还可以基于视图创建新的视图(在查询语句中用视图替换表)。
* 创建视图的格式如下:

```sql
CREATE [OR REPLACE] VIEW view_name(field1, field2...)
[ALGORITHM = {UNDEFINED|MERGE|TEMPTABLE}]
AS SELECT *
FROM table_1
[WITH CASCADED|LOCAL CHECK OPTION];
```

* 查看视图:
    * 可通过`SHOW TABLES`查看视图。表和视图将会一并显示。
    * 可通过`DESC view_name`查看视图的结构。
    * 可通过`SHOW TABLE STATUS LIKE 'view_name'\G`查看视图的属性信息。(`\G`目的在于使得查询结果纵向排列，增加可读性)
    * 可通过`SHOW CREATE VIEW view_name`查看视图的详细定义信息。

* 可以利用视图对数据格式化，一个例子如下:

```sql
CREATE VIEW view_1
AS SELECT CONCAT(field1, '===', field2) -- 将源表中的两个字段整合成一个新的
FROM table_1;
```

## 16.3 视图数据的更新

* 视图的创建和删除不影响基表的数据。但是对视图中的数据进行增删改时，基表中对应的数据也会发生变更。
* 视图的字段若要可更新，必须满足视图与基表中的字段存在**一对一**关系。下列情况会导致视图数据的更新失败：
    * 定义视图时指定了`ALGORITHM = TEMPTABLE`，此时不支持增删操作。
    * 视图中不包含基表中所有非空且没有默认值的字段，此时不支持插入操作。
    * 定义视图时采用了`JOIN`多表查询，此时不支持增删操作。
    * 定义视图字段时采用了数学表达式或子查询，此时不支持插入操作，也不能更新采用数学表达式、子查询的字段值。
    * 视图中若存在基表中不存在的字段（例如`DISTINCT/GROUP BY/HAVING/UNION/聚合函数`），此时不支持更新操作。
    * 视图中使用了子查询，且子查询引用了`FROM`中的表，此时不支持更新操作。
    * 视图基于一个**不可更新的视图**。
    * 常量视图。

> 虽可以更新视图数据，但视图的主要作用是**查询数据**，不建议在视图中更新数据。**视图中更新数据的所有操作，都是在基表中进行的**。

## 16.4 修改，删除视图

* 修改视图：

* 方式1: 使用`CREATE OR REPLACE`：

```sql
CREATE OR REPLACE VIEW view_name(field1, field2...)
AS SELECT *
FROM table_1;
```

* 方式2：使用`ALTER VIEW`：

```sql
ALTER VIEW view_name
AS SELECT *
FROM table_1;
```

* 删除视图

```sql
DROP VIEW IF EXISTS view_name;
```

> 注意：基于视图A、B创建新视图C，若删除A或B，将导致C的查询失败。此时应该手动修改、删除视图C。

## 16.5 总结

* 视图的优势：

* 将经常使用的查询语句固定为视图，可简化查询流程；
* 视图存储的是查询语句，不占用太多存储资源，可减少数据冗余；
* 保证数据安全，可以控制访问权限。
* 当业务系统需求发生较大变化时，可以利用视图减少改动工作量；
* 可以将复杂的查询逻辑分解为多个视图。

* 视图的不足：

* 基表的结构变化，视图的结构要及时变更，维护成本较高。